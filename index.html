<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ æ™ºèƒ½æŠ½å¥–ç³»ç»Ÿ (è‡ªåŠ¨å­˜æ¡£ç‰ˆ)</title>
    <!-- å¼•å…¥ Excel è§£æåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ ç¤¼èŠ±ç‰¹æ•ˆåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #00cec9;
            --accent-color: #fab1a0;
            --bg-gradient: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #2d3436;
        }

        .container {
            background-color: rgba(255, 255, 255, 0.96);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 750px;
            text-align: center;
            backdrop-filter: blur(10px);
            position: relative;
        }

        h1 {
            margin: 0 0 10px 0;
            color: #2d3436;
            font-weight: 800;
            font-size: 2.2rem;
            background: -webkit-linear-gradient(45deg, #6c5ce7, #0984e3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f1f2f6;
            border-radius: 10px;
        }

        .status {
            font-size: 14px;
            color: #636e72;
            font-weight: 600;
            text-align: left;
            flex-grow: 1;
            padding-left: 10px;
        }

        .btn-clear {
            padding: 6px 12px;
            font-size: 12px;
            background: #ff7675;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.8;
        }
        .btn-clear:hover { opacity: 1; }

        /* ä¸Šä¼ æŒ‰é’® */
        .upload-wrapper {
            margin-bottom: 25px;
        }
        
        input[type="file"] { display: none; }

        .custom-file-upload {
            display: inline-block;
            padding: 12px 30px;
            cursor: pointer;
            background: white;
            color: var(--primary-color);
            border: 2px dashed var(--primary-color);
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .custom-file-upload:hover {
            background: var(--primary-color);
            color: white;
        }

        /* æ ¸å¿ƒæŒ‰é’®ç»„ */
        .btn-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        button.action-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            color: white;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        button.action-btn:active { transform: scale(0.95); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .btn-one { background: linear-gradient(45deg, #0984e3, #74b9ff); }
        .btn-five { background: linear-gradient(45deg, #d63031, #ff7675); }
        
        button:disabled {
            background: #dfe6e9;
            color: #b2bec3;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* ç»“æœå±•ç¤ºåŒº */
        #result-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            min-height: 140px;
        }

        .result-card {
            background: white;
            border: 1px solid #dfe6e9;
            color: #2d3436;
            padding: 20px 10px;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            width: 100%;
            max-width: 180px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 6px;
            background: var(--secondary-color);
        }

        .result-card.single-mode {
            max-width: 90%;
            font-size: 45px;
            padding: 40px;
            background: linear-gradient(to right, #fff, #f0f9ff);
        }

        .rolling {
            color: #b2bec3;
            transform: scale(0.98);
        }

        .winner-pop {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            background: #ffeaa7;
            border: 2px solid #fdcb6e;
            transform: scale(1.1);
            box-shadow: 0 10px 25px rgba(253, 203, 110, 0.4);
            z-index: 10;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1.1); }
        }

        .hint {
            margin-top: 20px;
            font-size: 12px;
            color: #b2bec3;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ€ å¹¸è¿æŠ½å¥–</h1>
    
    <!-- çŠ¶æ€æ ä¸æ¸…é™¤æŒ‰é’® -->
    <div class="toolbar">
        <div class="status" id="statusText">ç­‰å¾…å¯¼å…¥åå•...</div>
        <button onclick="clearData()" class="btn-clear" id="clearBtn" style="display:none">ğŸ—‘ï¸ æ¸…é™¤åå•</button>
    </div>

    <!-- ä¸Šä¼ åŒºåŸŸ (å¦‚æœæœ‰ç¼“å­˜æ•°æ®åˆ™è‡ªåŠ¨éšè—ï¼Œæˆ–æ˜¾ç¤ºä¸ºé‡æ–°ä¸Šä¼ ) -->
    <div class="upload-wrapper">
        <label for="fileInput" class="custom-file-upload">
            ğŸ“‚ å¯¼å…¥ Excel (.xlsx)
        </label>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
    </div>

    <!-- æŠ½å¥–æŒ‰é’® -->
    <div class="btn-group">
        <button onclick="startLottery(1)" class="action-btn btn-one" id="btn1" disabled>ğŸ² æŠ½ 1 äºº</button>
        <button onclick="startLottery(5)" class="action-btn btn-five" id="btn5" disabled>ğŸš€ æŠ½ 5 äºº</button>
    </div>

    <!-- ç»“æœåŒºåŸŸ -->
    <div id="result-area"></div>
    
    <div class="hint">ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ« "å§“å" åˆ—å¹¶è‡ªåŠ¨ä¿å­˜ï¼Œåˆ·æ–°é¡µé¢ä¸ä¸¢å¤±</div>
</div>

<script>
    let nameList = [];
    let isDrawing = false;
    const STORAGE_KEY = 'lottery_names_v2'; // æœ¬åœ°å­˜å‚¨çš„é”®å

    // é¡µé¢åŠ è½½æ—¶ï¼šæ£€æŸ¥æœ¬åœ°ç¼“å­˜
    window.onload = function() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                nameList = JSON.parse(savedData);
                if (Array.isArray(nameList) && nameList.length > 0) {
                    updateStatus(true); // true è¡¨ç¤ºæ¥è‡ªç¼“å­˜
                }
            } catch (e) {
                console.error("ç¼“å­˜è¯»å–å¤±è´¥", e);
                localStorage.removeItem(STORAGE_KEY);
            }
        }
    };

    // 1. å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼ˆå«æ™ºèƒ½åˆ—è¯†åˆ«ï¼‰
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            try {
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½¬æ¢ä¸ºäºŒç»´æ•°ç»„ï¼ˆheader:1ï¼‰ä»¥ä¾¿åˆ†æè¡¨å¤´
                const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                if (rows.length === 0) {
                    alert("Excel æ–‡ä»¶ä¸ºç©ºï¼");
                    return;
                }

                // --- æ™ºèƒ½è¯†åˆ«åˆ—é€»è¾‘ ---
                let targetColIndex = 0; // é»˜è®¤ç¬¬0åˆ—ï¼ˆAåˆ—ï¼‰
                const headerRow = rows[0]; // ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´

                // å°è¯•æŸ¥æ‰¾åŒ…å« "å§“å"ã€"åå­—"ã€"Name" çš„åˆ—
                const keywords = ["å§“å", "åå­—", "name", "names", "äººå‘˜"];
                let foundIndex = -1;

                if (headerRow && headerRow.length > 0) {
                    foundIndex = headerRow.findIndex(cell => {
                        if (!cell) return false;
                        const cellStr = String(cell).trim().toLowerCase();
                        return keywords.some(k => cellStr.includes(k));
                    });
                }

                if (foundIndex !== -1) {
                    targetColIndex = foundIndex;
                    console.log(`æ™ºèƒ½è¯†åˆ«ï¼šåœ¨ç¬¬ ${targetColIndex + 1} åˆ—æ‰¾åˆ°å§“ååˆ—`);
                } else {
                    console.log("æœªæ‰¾åˆ°ç‰¹å®šè¡¨å¤´ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬ 1 åˆ—");
                }

                // æå–æ•°æ®ï¼ˆä»æ‰€æœ‰è¡Œä¸­æå–æŒ‡å®šåˆ—ï¼‰
                // ä½¿ç”¨ Set å»é‡
                const extractedNames = new Set();
                
                rows.forEach(row => {
                    const cellValue = row[targetColIndex];
                    if (cellValue) {
                        const cleanName = String(cellValue).trim();
                        // è¿‡æ»¤æ‰è¡¨å¤´æœ¬èº«å’Œç©ºå€¼
                        if (cleanName && !keywords.includes(cleanName.toLowerCase())) {
                            extractedNames.add(cleanName);
                        }
                    }
                });

                nameList = Array.from(extractedNames);

                if (nameList.length === 0) {
                    alert("æœªåœ¨æ–‡ä»¶ä¸­æå–åˆ°æœ‰æ•ˆåå•ï¼Œè¯·æ£€æŸ¥æ ¼å¼ã€‚");
                    return;
                }

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(STORAGE_KEY, JSON.stringify(nameList));
                
                updateStatus(false);
                // é‡ç½® file inputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒåæ–‡ä»¶
                document.getElementById('fileInput').value = ''; 

            } catch (error) {
                console.error(error);
                alert("æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æœªåŠ å¯†ä¸”æ ¼å¼æ­£ç¡®ã€‚");
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // æ›´æ–°ç•Œé¢çŠ¶æ€
    function updateStatus(fromCache = false) {
        const statusText = document.getElementById('statusText');
        const btn1 = document.getElementById('btn1');
        const btn5 = document.getElementById('btn5');
        const clearBtn = document.getElementById('clearBtn');

        if (nameList.length > 0) {
            const sourceInfo = fromCache ? '<span style="color:#0984e3">[å·²æ¢å¤ä¸Šæ¬¡å­˜æ¡£]</span>' : '<span style="color:#00b894">[æ–°å¯¼å…¥]</span>';
            statusText.innerHTML = `âœ… å°±ç»ª: å…± <strong>${nameList.length}</strong> äºº ${sourceInfo}`;
            
            btn1.disabled = false;
            btn5.disabled = nameList.length < 5;
            clearBtn.style.display = 'block';
        } else {
            statusText.innerText = "ç­‰å¾…å¯¼å…¥åå•...";
            btn1.disabled = true;
            btn5.disabled = true;
            clearBtn.style.display = 'none';
        }
    }

    // æ¸…é™¤æ•°æ®
    function clearData() {
        if(confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰çš„åå•å­˜æ¡£å—ï¼Ÿ')) {
            localStorage.removeItem(STORAGE_KEY);
            nameList = [];
            document.getElementById('result-area').innerHTML = '';
            updateStatus();
        }
    }

    // --- æŠ½å¥–é€»è¾‘ (ä¸ä¹‹å‰ç›¸åŒ) ---
    function startLottery(count) {
        if (isDrawing) return; 
        if (nameList.length < count) return alert("åå•äººæ•°ä¸è¶³ï¼");

        isDrawing = true;
        setButtonsState(true); 

        const resultArea = document.getElementById('result-area');
        resultArea.innerHTML = '';

        let tempPool = [...nameList];
        for (let i = tempPool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [tempPool[i], tempPool[j]] = [tempPool[j], tempPool[i]];
        }
        const winners = tempPool.slice(0, count);

        const cardElements = [];
        for (let i = 0; i < count; i++) {
            const card = document.createElement('div');
            card.className = 'result-card rolling';
            if (count === 1) card.classList.add('single-mode'); 
            card.innerText = '...';
            resultArea.appendChild(card);
            cardElements.push(card);
        }

        cardElements.forEach((card, index) => {
            let rollInterval = setInterval(() => {
                const randomName = nameList[Math.floor(Math.random() * nameList.length)];
                card.innerText = randomName;
            }, 50);

            // æŠ½1äºº2ç§’åœï¼ŒæŠ½5äººäº¤é”™åœ
            const stopDelay = count === 1 ? 2000 : 1500 + (index * 400);

            setTimeout(() => {
                clearInterval(rollInterval);
                card.innerText = winners[index]; 
                card.classList.remove('rolling');
                card.classList.add('winner-pop'); 
                
                if (index === count - 1) {
                    isDrawing = false;
                    setButtonsState(false);
                    triggerConfetti(); 
                }
            }, stopDelay);
        });
    }

    function setButtonsState(disabled) {
        document.getElementById('btn1').disabled = disabled;
        document.getElementById('btn5').disabled = disabled || nameList.length < 5;
        document.getElementById('clearBtn').disabled = disabled;
    }

    function triggerConfetti() {
        const duration = 2500;
        const end = Date.now() + duration;

        (function frame() {
            confetti({
                particleCount: 5,
                angle: 60,
                spread: 55,
                origin: { x: 0 },
                colors: ['#0984e3', '#00b894', '#fdcb6e']
            });
            confetti({
                particleCount: 5,
                angle: 120,
                spread: 55,
                origin: { x: 1 },
                colors: ['#0984e3', '#00b894', '#fdcb6e']
            });

            if (Date.now() < end) {
                requestAnimationFrame(frame);
            }
        }());
    }
</script>

</body>
</html>
